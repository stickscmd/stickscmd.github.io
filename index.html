<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MedAssist - AI Medication Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');

        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: #E2E8F0;
            color: #1E293B;
            -webkit-tap-highlight-color: transparent;
        }

        .calendar-strip {
            display: flex;
            overflow-x: auto;
            scrollbar-width: none;
            gap: 12px;
            padding: 12px 0;
        }
        .calendar-strip::-webkit-scrollbar { display: none; }

        .day-card {
            flex: 0 0 65px;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 18px 0;
            border-radius: 24px;
            cursor: pointer;
            background: #E2E8F0;
            transition: all 0.2s;
            color: #64748B;
        }
        .day-card.active {
            background-color: #CBD5E1;
            color: #1E293B;
        }

        #side-menu { transform: translateX(-100%); transition: transform 0.4s; }
        #side-menu.open { transform: translateX(0); }

        #ai-sheet { transform: translateY(100%); transition: transform 0.4s; }
        #ai-sheet.open { transform: translateY(0); }

        .chat-msg {
            max-width: 85%;
            padding: 14px 20px;
            border-radius: 20px;
            font-size: 15px;
            font-weight: 500;
            margin-bottom: 12px;
        }
        .msg-user {
            background: #475569;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 4px;
        }
        .msg-bot {
            background: white;
            color: #1E293B;
            align-self: flex-start;
            border-bottom-left-radius: 4px;
            border: 1px solid #E2E8F0;
        }

        .hidden-scale { transform: scale(0); opacity: 0; pointer-events: none; }

        .typing-dot {
            width: 6px;
            height: 6px;
            background: #cbd5e1;
            border-radius: 50%;
            animation: bounce 1.4s infinite;
        }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .usage-bar {
            width: 100%;
            height: 8px;
            background: #E2E8F0;
            border-radius: 4px;
            overflow: hidden;
        }
        .usage-fill {
            height: 100%;
            background: linear-gradient(90deg, #475569, #64748B);
            transition: width 0.3s;
        }

        .auth-button {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            width: 100%;
            padding: 12px;
            border-radius: 12px;
            font-weight: bold;
            transition: all 0.2s;
            border: 2px solid;
            margin-bottom: 10px;
        }

        .google-btn { background: white; color: #1f2937; border-color: #e5e7eb; }
        .google-btn:hover { background: #f9fafb; }
        .apple-btn { background: #000; color: white; border-color: #000; }
        .apple-btn:hover { background: #1a1a1a; }
        .microsoft-btn { background: #0078d4; color: white; border-color: #0078d4; }
        .microsoft-btn:hover { background: #106ebe; }
    </style>
</head>
<body class="pb-28">

    <!-- LOGIN SCREEN -->
    <div id="loginSection" class="fixed inset-0 z-[200] flex items-center justify-center p-6 bg-slate-200">
        <div class="bg-white rounded-[3rem] shadow-xl w-full max-w-md p-10">
            <div class="bg-slate-100 w-20 h-20 rounded-[2rem] flex items-center justify-center mx-auto mb-8">
                <i class="fas fa-hand-holding-medical text-3xl text-slate-500"></i>
            </div>
            <h2 class="text-3xl font-extrabold text-slate-900 text-center">MedAssist</h2>
            <p class="text-slate-500 mt-2 mb-8 text-center font-medium">AI-Powered Health Assistant</p>
            
            <div class="space-y-3 mb-6">
                <button type="button" onclick="signInWithGoogle()" class="auth-button google-btn">
                    <i class="fab fa-google text-lg"></i> Sign in with Google
                </button>
                <button type="button" onclick="signInWithApple()" class="auth-button apple-btn">
                    <i class="fab fa-apple text-lg"></i> Sign in with Apple
                </button>
                <button type="button" onclick="signInWithMicrosoft()" class="auth-button microsoft-btn">
                    <i class="fab fa-microsoft text-lg"></i> Sign in with Microsoft
                </button>
                <p class="text-[10px] text-slate-400 text-center mt-2">
                    Use your existing account or create a new one
                </p>
            </div>

            <div class="relative mb-6">
                <div class="absolute inset-0 flex items-center">
                    <div class="w-full border-t border-slate-200"></div>
                </div>
                <div class="relative flex justify-center text-sm">
                    <span class="px-2 bg-white text-slate-500">or use email</span>
                </div>
            </div>

            <form onsubmit="handleAuth(event)" class="space-y-4">
                <div id="authError" class="hidden p-4 bg-red-50 text-red-700 text-sm font-bold rounded-2xl border border-red-100">
                    <span id="errorMessage">Invalid credentials</span>
                </div>
                <input id="email" type="email" placeholder="Email" class="w-full px-6 py-4 rounded-2xl bg-slate-50 border border-slate-200 font-semibold text-slate-800" required>
                <input id="password" type="password" placeholder="Password" class="w-full px-6 py-4 rounded-2xl bg-slate-50 border border-slate-200 font-semibold text-slate-800" required>
                <button type="submit" class="w-full py-5 bg-slate-800 text-white text-lg font-bold rounded-2xl shadow-lg">Sign In</button>
            </form>
            <button onclick="toggleAuthMode()" class="mt-6 w-full text-slate-500 font-bold text-sm underline">Create account instead</button>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="appSection" class="hidden">
        <header class="bg-white/80 backdrop-blur-md border-b border-slate-300 px-4 sm:px-8 py-5 sticky top-0 z-40">
            <div class="flex items-center justify-between max-w-5xl mx-auto">
                <div class="flex items-center gap-4">
                    <button onclick="toggleSideMenu(true)" class="w-11 h-11 rounded-xl bg-slate-100 flex items-center justify-center">
                        <i class="fas fa-bars text-slate-600"></i>
                    </button>
                    <div class="flex items-center gap-2">
                        <div class="w-9 h-9 bg-slate-800 text-white rounded-xl flex items-center justify-center">
                            <i class="fas fa-briefcase-medical text-sm"></i>
                        </div>
                        <h1 class="text-lg font-extrabold text-slate-800">MedAssist</h1>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button onclick="toggleAiSheet(true)" class="w-11 h-11 rounded-xl bg-slate-100 flex items-center justify-center">
                        <i class="fas fa-robot text-slate-600"></i>
                    </button>
                    <button onclick="toggleSettingsModal(true)" class="w-11 h-11 rounded-xl bg-slate-100 flex items-center justify-center">
                        <i class="fas fa-cog text-slate-600"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <div id="side-menu-overlay" onclick="toggleSideMenu(false)" class="fixed inset-0 bg-slate-900/40 z-50 hidden"></div>
        <div id="side-menu" class="fixed top-0 left-0 h-full w-72 bg-slate-50 z-[60] shadow-2xl flex flex-col p-8">
            <div class="mb-10 pt-6">
                <h2 id="user-display-name" class="text-2xl font-extrabold text-slate-800">User</h2>
                <p id="user-display-email" class="text-slate-500 text-sm">user@example.com</p>
            </div>
            <nav class="flex-1 space-y-2">
                <button onclick="switchTab('today')" class="w-full text-left p-4 rounded-2xl font-bold bg-white text-slate-800 border border-slate-200">
                    <i class="fas fa-calendar-day"></i> Today
                </button>
                <button onclick="switchTab('list')" class="w-full text-left p-4 rounded-2xl font-bold text-slate-500 hover:bg-white">
                    <i class="fas fa-list"></i> Library
                </button>
            </nav>
            <button onclick="logout()" class="w-full p-4 text-slate-400 font-bold border-t border-slate-200 hover:text-red-500">
                <i class="fas fa-sign-out-alt"></i> Logout
            </button>
        </div>

        <main class="max-w-xl mx-auto p-6">
            <div id="view-today" class="space-y-6">
                <div class="bg-slate-50/50 rounded-[2.5rem] p-6 border border-slate-300">
                    <div id="calendar-strip" class="calendar-strip"></div>
                </div>
                <div id="status-card" class="bg-white rounded-[2.5rem] p-8 border border-slate-300">
                    <h2 class="text-xl font-extrabold text-slate-800">Daily Goal</h2>
                    <p id="summary-text" class="text-slate-500 text-base mt-2">No schedule for this day.</p>
                </div>
                <div id="schedule-container" class="space-y-4"></div>
            </div>
            <div id="view-list" class="hidden space-y-6">
                <h3 class="text-xl font-extrabold text-slate-800">Medication Library</h3>
                <div id="med-list-container" class="space-y-4"></div>
            </div>
        </main>

        <!-- Floating Action Menu -->
        <div class="fixed bottom-8 right-8 flex flex-col items-end gap-3 z-50">
            <div id="fab-menu" class="hidden-scale flex flex-col gap-3">
                <button onclick="triggerScan()" class="bg-white px-6 py-4 rounded-2xl shadow-lg border border-slate-200 font-bold text-slate-700">
                    <i class="fas fa-camera"></i> Scan
                </button>
                <button onclick="toggleModal(true)" class="bg-white px-6 py-4 rounded-2xl shadow-lg border border-slate-200 font-bold text-slate-700">
                    <i class="fas fa-plus-circle"></i> Manual
                </button>
            </div>
            <button id="fab-main" onclick="toggleFabMenu()" class="w-16 h-16 bg-slate-800 text-white rounded-[1.5rem] shadow-xl flex items-center justify-center text-2xl">
                <i class="fas fa-plus"></i>
            </button>
        </div>

        <!-- AI Assistant Sheet -->
        <div id="ai-sheet-overlay" onclick="toggleAiSheet(false)" class="fixed inset-0 bg-slate-900/40 z-[90] hidden"></div>
        <div id="ai-sheet" class="fixed bottom-0 left-0 right-0 bg-slate-50 z-[100] rounded-t-[3rem] h-[80vh] shadow-2xl flex flex-col overflow-hidden">
            <div class="p-6 bg-white border-b border-slate-200 flex items-center justify-between">
                <span class="font-extrabold text-lg text-slate-800">AI Assistant</span>
                <button onclick="toggleAiSheet(false)" class="text-slate-400 p-2"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div id="chat-container" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4">
                <div class="msg-bot chat-msg">Hi! How can I help?</div>
            </div>
            <div class="p-6 bg-white border-t border-slate-200">
                <form onsubmit="handleChatSubmit(event)" class="relative">
                    <input type="text" id="chat-input" placeholder="Type a message..." class="w-full pl-6 pr-16 py-4 rounded-2xl bg-slate-100 border border-slate-200 font-semibold text-slate-800">
                    <button type="submit" class="absolute right-2 top-2 w-11 h-11 bg-slate-800 text-white rounded-xl flex items-center justify-center">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Medication Modal -->
    <div id="modal-overlay" class="fixed inset-0 hidden z-[110] bg-slate-900/40 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl overflow-y-auto max-h-[90vh]">
            <h2 class="text-2xl font-extrabold text-slate-800 mb-6">Add Medication</h2>
            <form id="med-form" class="space-y-4">
                <input type="text" id="med-name" placeholder="Name" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800" required>
                <input type="text" id="med-dose" placeholder="Dosage" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800" required>
                <input type="time" id="med-time" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800" required>
                <select id="med-frequency" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800">
                    <option value="daily">Daily</option>
                    <option value="every-other">Every Other Day</option>
                    <option value="weekly">Weekly</option>
                </select>
                <input type="date" id="med-start-date" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800" required>
                <input type="date" id="med-end-date" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800">
                <div class="flex gap-3 pt-6">
                    <button type="button" onclick="toggleModal(false)" class="flex-1 py-4 bg-slate-100 rounded-2xl font-bold text-slate-500">Cancel</button>
                    <button type="submit" class="flex-1 py-4 bg-slate-800 text-white rounded-2xl font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="fixed inset-0 hidden z-[250] bg-slate-900/40 flex items-center justify-center p-6">
        <div class="bg-white w-full max-w-sm rounded-[3rem] p-8 shadow-2xl max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-extrabold text-slate-800 mb-2">Settings</h2>
            <p class="text-slate-500 text-sm mb-6">Configure AI services.</p>
            <form onsubmit="saveSettings(event)" class="space-y-5">
                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">AI Provider</label>
                    <select id="settings-ai-provider" onchange="updateApiKeyFields()" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800">
                        <option value="gemini">ðŸ”´ Google Gemini</option>
                        <option value="openai">ðŸŸ¢ OpenAI</option>
                        <option value="anthropic">âš« Anthropic Claude</option>
                    </select>
                </div>

                <div id="gemini-fields">
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">Gemini API Key</label>
                    <input type="password" id="settings-gemini-key" placeholder="Paste key" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800">
                </div>

                <div id="openai-fields" class="hidden">
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">OpenAI API Key</label>
                    <input type="password" id="settings-openai-key" placeholder="Paste key" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800">
                </div>

                <div id="anthropic-fields" class="hidden">
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">Anthropic API Key</label>
                    <input type="password" id="settings-anthropic-key" placeholder="Paste key" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800">
                </div>

                <div>
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">OCR Provider</label>
                    <select id="settings-ocr-provider" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800">
                        <option value="ocrspace">OCR.Space (Free)</option>
                        <option value="ai-model">AI Model (Using Chat Provider)</option>
                    </select>
                </div>

                <div id="ocrspace-fields">
                    <label class="text-[10px] font-bold text-slate-400 uppercase block mb-2">OCR.Space API Key (Optional)</label>
                    <input type="password" id="settings-ocrspace-key" placeholder="Free account key" class="w-full p-4 rounded-2xl bg-slate-50 border border-slate-200 font-bold text-slate-800">
                    <p class="text-[10px] text-slate-400 mt-1"><a href="https://ocr.space/ocrapi" target="_blank" class="text-blue-500 underline">Get free key</a></p>
                </div>

                <div class="bg-slate-50 rounded-2xl p-4 border border-slate-200">
                    <h3 class="text-[11px] font-bold text-slate-600 uppercase mb-3">API Usage <span id="reset-timer" class="text-slate-400 text-[9px]"></span></h3>
                    <div class="mb-2 text-[10px] font-bold text-slate-600">Provider: <span id="current-provider">Gemini</span></div>
                    <div class="mb-2 flex justify-between items-center">
                        <span id="usage-text" class="text-sm font-bold text-slate-700">0 / 15 requests</span>
                        <button type="button" onclick="resetApiUsage()" class="text-[10px] font-bold text-slate-500 bg-white border border-slate-300 px-3 py-1 rounded-full">Reset</button>
                    </div>
                    <div class="usage-bar">
                        <div id="usage-fill" class="usage-fill" style="width: 0%"></div>
                    </div>
                </div>

                <div class="flex gap-3 pt-4">
                    <button type="button" onclick="toggleSettingsModal(false)" class="flex-1 py-4 bg-slate-100 rounded-2xl font-bold text-slate-500">Cancel</button>
                    <button type="submit" class="flex-1 py-4 bg-slate-800 text-white rounded-2xl font-bold">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Scanning Overlay -->
    <div id="scan-loader" class="fixed inset-0 z-[300] bg-white hidden flex flex-col items-center justify-center p-10 text-center">
        <div id="loader-spinner" class="w-20 h-20 border-8 border-slate-200 border-t-slate-800 rounded-full animate-spin mb-8"></div>
        <div id="loader-success" class="hidden w-20 h-20 bg-green-100 text-green-600 rounded-full flex items-center justify-center mb-8 text-4xl">
            <i class="fas fa-check"></i>
        </div>
        <h3 id="loader-title" class="text-2xl font-bold text-slate-800">Processing...</h3>
        <p id="loader-text" class="text-slate-500 text-lg mt-3">Extracting medications.</p>
        <button id="loader-close" onclick="closeLoader()" class="hidden mt-8 px-8 py-4 bg-slate-800 text-white rounded-2xl font-bold">Done</button>
    </div>

    <input type="file" id="scan-input" accept="image/*" class="hidden" onchange="handleFileSelect(event)">

    <script>
        // Handle OAuth callbacks on page load
        window.addEventListener('load', () => {
            handleOAuthCallback();
        });

        let medications = [];
        let completedDoses = {};
        let selectedDate = new Date();
        selectedDate.setHours(0,0,0,0);
        let currentUser = null;
        let apiUsageTracker = { count: 0, timestamp: Date.now(), limit: 15, provider: 'gemini' };

        // --- SOCIAL LOGIN ---
        function signInWithGoogle() {
            const googleAuthUrl = `https://accounts.google.com/o/oauth2/v2/auth?client_id=YOUR_GOOGLE_CLIENT_ID&redirect_uri=${encodeURIComponent(window.location.origin + '?auth=google')}&response_type=code&scope=openid%20email%20profile`;
            window.location.href = googleAuthUrl;
        }

        function signInWithApple() {
            const appleAuthUrl = `https://appleid.apple.com/auth/authorize?client_id=YOUR_APPLE_CLIENT_ID&redirect_uri=${encodeURIComponent(window.location.origin + '?auth=apple')}&response_type=code&scope=name%20email&response_mode=form_post`;
            window.location.href = appleAuthUrl;
        }

        function signInWithMicrosoft() {
            const microsoftAuthUrl = `https://login.microsoftonline.com/common/oauth2/v2.0/authorize?client_id=YOUR_MICROSOFT_CLIENT_ID&redirect_uri=${encodeURIComponent(window.location.origin + '?auth=microsoft')}&response_type=code&scope=openid%20profile%20email`;
            window.location.href = microsoftAuthUrl;
        }

        // --- Handle OAuth Callbacks ---
        function handleOAuthCallback() {
            const params = new URLSearchParams(window.location.search);
            const authProvider = params.get('auth');
            const code = params.get('code');
            const state = params.get('state');

            if (!authProvider) return;

            if (authProvider === 'google' && code) {
                // Exchange code for token (would need backend)
                const email = `google-${Date.now()}@medassist.local`;
                const name = 'Google User';
                handleSocialAuth(email, name);
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (authProvider === 'apple' && code) {
                const email = `apple-${Date.now()}@medassist.local`;
                const name = 'Apple User';
                handleSocialAuth(email, name);
                window.history.replaceState({}, document.title, window.location.pathname);
            } else if (authProvider === 'microsoft' && code) {
                const email = `microsoft-${Date.now()}@medassist.local`;
                const name = 'Microsoft User';
                handleSocialAuth(email, name);
                window.history.replaceState({}, document.title, window.location.pathname);
            }
        }

        function handleSocialAuth(email, name) {
            const users = JSON.parse(localStorage.getItem('ms_mock_users') || '{}');
            users[email] = { password: 'social_login', name };
            localStorage.setItem('ms_mock_users', JSON.stringify(users));
            
            currentUser = { email, name };
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = currentUser.name;
            document.getElementById('user-display-email').innerText = currentUser.email;
            
            medications = JSON.parse(localStorage.getItem(`ms_meds_${email}`) || '[]');
            completedDoses = JSON.parse(localStorage.getItem(`ms_logs_${email}`) || '{}');
            document.getElementById('med-start-date').value = new Date().toISOString().split('T')[0];
            
            initApiUsageTracker();
            renderAll();
        }

        // --- API USAGE TRACKING ---
        function initApiUsageTracker() {
            const saved = localStorage.getItem('medassist_api_usage');
            if (saved) {
                const data = JSON.parse(saved);
                const now = Date.now();
                const hoursPassed = (now - data.timestamp) / (1000 * 60 * 60);
                if (hoursPassed >= 24) {
                    apiUsageTracker = { count: 0, timestamp: now, limit: 15, provider: data.provider || 'gemini' };
                } else {
                    apiUsageTracker = data;
                }
            }
            updateUsageDisplay();
            setInterval(updateUsageDisplay, 1000);
        }

        function updateUsageDisplay() {
            const remaining = 24 * 60 * 60 * 1000 - (Date.now() - apiUsageTracker.timestamp);
            const hours = Math.floor(remaining / (60 * 60 * 1000));
            const minutes = Math.floor((remaining % (60 * 60 * 1000)) / (60 * 1000));
            
            document.getElementById('usage-text').innerText = `${apiUsageTracker.count} / ${apiUsageTracker.limit} requests`;
            document.getElementById('usage-fill').style.width = `${(apiUsageTracker.count / apiUsageTracker.limit) * 100}%`;
            document.getElementById('reset-timer').innerText = `(Resets in ${hours}h ${minutes}m)`;
            document.getElementById('current-provider').innerText = apiUsageTracker.provider.charAt(0).toUpperCase() + apiUsageTracker.provider.slice(1);
        }

        function incrementApiUsage() {
            apiUsageTracker.count++;
            localStorage.setItem('medassist_api_usage', JSON.stringify(apiUsageTracker));
            updateUsageDisplay();
        }

        function resetApiUsage() {
            apiUsageTracker = { count: 0, timestamp: Date.now(), limit: 15, provider: apiUsageTracker.provider };
            localStorage.setItem('medassist_api_usage', JSON.stringify(apiUsageTracker));
            updateUsageDisplay();
        }

        function canUseApi() {
            return apiUsageTracker.count < apiUsageTracker.limit;
        }

        function getApiProvider() {
            return localStorage.getItem('medassist_ai_provider') || 'gemini';
        }

        function getApiKey() {
            const provider = getApiProvider();
            if (provider === 'gemini') return localStorage.getItem('medassist_gemini_key') || '';
            if (provider === 'openai') return localStorage.getItem('medassist_openai_key') || '';
            if (provider === 'anthropic') return localStorage.getItem('medassist_anthropic_key') || '';
            return '';
        }

        function updateApiKeyFields() {
            const provider = document.getElementById('settings-ai-provider').value;
            document.getElementById('gemini-fields').classList.toggle('hidden', provider !== 'gemini');
            document.getElementById('openai-fields').classList.toggle('hidden', provider !== 'openai');
            document.getElementById('anthropic-fields').classList.toggle('hidden', provider !== 'anthropic');
        }

        // --- HELPERS ---
        function dateDiffInDays(a, b) {
            return Math.floor((a - b) / (1000 * 60 * 60 * 24));
        }

        // --- AUTH ---
        function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            const users = JSON.parse(localStorage.getItem('ms_mock_users') || '{}');

            if (!users[email] || users[email].password !== password) {
                if (!users[email]) {
                    users[email] = { password, name: email.split('@')[0] };
                    localStorage.setItem('ms_mock_users', JSON.stringify(users));
                } else {
                    document.getElementById('authError').classList.remove('hidden');
                    return;
                }
            }

            currentUser = { email, name: users[email].name };
            document.getElementById('loginSection').classList.add('hidden');
            document.getElementById('appSection').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = currentUser.name;
            document.getElementById('user-display-email').innerText = currentUser.email;
            
            medications = JSON.parse(localStorage.getItem(`ms_meds_${email}`) || '[]');
            completedDoses = JSON.parse(localStorage.getItem(`ms_logs_${email}`) || '{}');
            document.getElementById('med-start-date').value = new Date().toISOString().split('T')[0];
            
            initApiUsageTracker();
            renderAll();
        }

        function toggleAuthMode() {
            const form = document.querySelector('#loginSection form');
            const isLogin = form.style.display !== 'none';
            const title = document.querySelector('#loginSection h2');
            if (isLogin) {
                form.innerHTML = form.innerHTML === form.innerHTML ? form.innerHTML : form.innerHTML;
            }
        }

        function logout() { window.location.reload(); }

        function toggleSettingsModal(show) {
            const modal = document.getElementById('settings-modal');
            modal.classList.toggle('hidden', !show);
            if (show) {
                const provider = getApiProvider();
                document.getElementById('settings-ai-provider').value = provider;
                document.getElementById('settings-gemini-key').value = localStorage.getItem('medassist_gemini_key') || '';
                document.getElementById('settings-openai-key').value = localStorage.getItem('medassist_openai_key') || '';
                document.getElementById('settings-anthropic-key').value = localStorage.getItem('medassist_anthropic_key') || '';
                document.getElementById('settings-ocrspace-key').value = localStorage.getItem('medassist_ocrspace_key') || '';
                document.getElementById('settings-ocr-provider').value = localStorage.getItem('medassist_ocr_provider') || 'ocrspace';
                updateApiKeyFields();
            }
        }

        function saveSettings(e) {
            e.preventDefault();
            const provider = document.getElementById('settings-ai-provider').value;
            localStorage.setItem('medassist_ai_provider', provider);
            
            if (provider === 'gemini') {
                localStorage.setItem('medassist_gemini_key', document.getElementById('settings-gemini-key').value);
            } else if (provider === 'openai') {
                localStorage.setItem('medassist_openai_key', document.getElementById('settings-openai-key').value);
            } else if (provider === 'anthropic') {
                localStorage.setItem('medassist_anthropic_key', document.getElementById('settings-anthropic-key').value);
            }
            
            localStorage.setItem('medassist_ocrspace_key', document.getElementById('settings-ocrspace-key').value);
            localStorage.setItem('medassist_ocr_provider', document.getElementById('settings-ocr-provider').value);
            
            apiUsageTracker.provider = provider;
            localStorage.setItem('medassist_api_usage', JSON.stringify(apiUsageTracker));
            updateUsageDisplay();
            toggleSettingsModal(false);
        }

        // --- APP LOGIC ---
        const renderAll = () => { renderStrip(); renderSchedule(); renderLibrary(); updateSummary(); };

        const renderStrip = () => {
            const container = document.getElementById('calendar-strip');
            container.innerHTML = '';
            for(let i = -7; i <= 7; i++) {
                const d = new Date(selectedDate);
                d.setDate(selectedDate.getDate() + i); 
                d.setHours(0,0,0,0);
                const card = document.createElement('div');
                card.className = `day-card ${d.getTime() === selectedDate.getTime() ? 'active' : ''}`;
                card.innerHTML = `<span class="text-[9px] font-bold uppercase mb-1">${d.toLocaleDateString('en-US',{weekday:'short'})}</span><span class="text-lg font-bold">${d.getDate()}</span>`;
                card.onclick = () => { selectedDate = d; renderAll(); };
                container.appendChild(card);
            }
        };

        const renderSchedule = () => {
            const container = document.getElementById('schedule-container');
            const key = selectedDate.toDateString();
            const done = completedDoses[key] || [];
            
            const visibleMeds = medications.filter(m => {
                const start = new Date(m.startDate);
                start.setHours(0,0,0,0);
                const end = m.endDate ? new Date(m.endDate) : null;
                if (end) end.setHours(0,0,0,0);

                if (selectedDate < start) return false;
                if (end && selectedDate > end) return false;

                const diff = dateDiffInDays(selectedDate, start);
                if (m.frequency === 'every-other' && diff % 2 !== 0) return false;
                if (m.frequency === 'weekly' && diff % 7 !== 0) return false;

                return true;
            }).sort((a,b) => a.time.localeCompare(b.time));
            
            if(visibleMeds.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 font-bold py-20">No medications scheduled.</div>';
                return;
            }
            container.innerHTML = visibleMeds.map(m => {
                const isDone = done.includes(m.id);
                return `<div class="bg-white p-6 rounded-[2rem] flex items-center justify-between border border-slate-300">
                    <div class="flex items-center gap-5">
                        <div class="bg-slate-100 text-slate-600 px-4 py-2 rounded-xl text-xs font-bold">${m.time}</div>
                        <div>
                            <div class="text-lg font-bold text-slate-800 ${isDone ? 'line-through opacity-20' : ''}">${m.name}</div>
                            <div class="text-xs text-slate-400 font-bold">${m.dose}</div>
                        </div>
                    </div>
                    <button onclick="toggleDose('${m.id}')" class="w-14 h-14 rounded-2xl flex items-center justify-center ${isDone ? 'bg-slate-800 text-white' : 'bg-slate-50 text-slate-300 border border-slate-200'}">
                        <i class="fas ${isDone ? 'fa-check' : 'fa-circle'}"></i>
                    </button>
                </div>`;
            }).join('');
        };

        const renderLibrary = () => {
            const container = document.getElementById('med-list-container');
            if(medications.length === 0) {
                container.innerHTML = '<div class="text-center text-slate-400 font-bold p-10">Library is empty.</div>';
                return;
            }
            container.innerHTML = medications.map(m => `
                <div class="bg-white p-6 rounded-[2rem] flex items-center justify-between border border-slate-300">
                    <div class="flex items-center gap-5">
                        <div class="w-12 h-12 bg-slate-50 rounded-xl flex items-center justify-center text-slate-400"><i class="fas fa-pills"></i></div>
                        <div>
                            <div class="text-lg font-bold text-slate-800">${m.name}</div>
                            <div class="text-[10px] text-slate-400 font-bold">${m.dose}</div>
                        </div>
                    </div>
                    <button onclick="deleteMed('${m.id}')" class="text-slate-200 hover:text-red-400"><i class="fas fa-trash"></i></button>
                </div>`).join('');
        };

        const updateSummary = () => {
            const container = document.getElementById('schedule-container');
            const totalOnDay = container.children.length;
            const done = (completedDoses[selectedDate.toDateString()] || []).length;
            document.getElementById('summary-text').innerText = totalOnDay > 0 ? `${done} of ${totalOnDay} completed.` : "No schedule for this day.";
        };

        window.toggleDose = (id) => {
            const key = selectedDate.toDateString();
            if(!completedDoses[key]) completedDoses[key] = [];
            const idx = completedDoses[key].indexOf(id);
            if(idx > -1) completedDoses[key].splice(idx,1); else completedDoses[key].push(id);
            localStorage.setItem(`ms_logs_${currentUser.email}`, JSON.stringify(completedDoses));
            renderAll();
        };

        window.deleteMed = (id) => {
            medications = medications.filter(m => m.id !== id);
            localStorage.setItem(`ms_meds_${currentUser.email}`, JSON.stringify(medications));
            renderAll();
        };

        function toggleFabMenu() {
            document.getElementById('fab-menu').classList.toggle('hidden-scale');
        }
        function toggleModal(s) { document.getElementById('modal-overlay').classList.toggle('hidden', !s); }
        function toggleSideMenu(s) {
            document.getElementById('side-menu').classList.toggle('open', s);
            document.getElementById('side-menu-overlay').classList.toggle('hidden', !s);
        }
        function toggleAiSheet(s) {
            document.getElementById('ai-sheet').classList.toggle('open', s);
            document.getElementById('ai-sheet-overlay').classList.toggle('hidden', !s);
        }
        function switchTab(t) {
            document.getElementById('view-today').classList.toggle('hidden', t !== 'today');
            document.getElementById('view-list').classList.toggle('hidden', t !== 'list');
            toggleSideMenu(false);
        }

        document.getElementById('med-form').onsubmit = (e) => {
            e.preventDefault();
            medications.push({
                id: Math.random().toString(36).substr(2,9),
                name: document.getElementById('med-name').value,
                dose: document.getElementById('med-dose').value,
                time: document.getElementById('med-time').value,
                frequency: document.getElementById('med-frequency').value,
                startDate: document.getElementById('med-start-date').value,
                endDate: document.getElementById('med-end-date').value || null
            });
            localStorage.setItem(`ms_meds_${currentUser.email}`, JSON.stringify(medications));
            renderAll();
            toggleModal(false);
            e.target.reset();
            document.getElementById('med-start-date').value = new Date().toISOString().split('T')[0];
        };

        // --- AI FUNCTIONS ---
        async function callGemini(text, imageData = null) {
            const key = localStorage.getItem('medassist_gemini_key');
            if (!key) throw new Error('No Gemini API key');
            
            const body = {
                contents: [{ parts: [{ text }] }],
                systemInstruction: { parts: [{ text: `Medical assistant. User: ${currentUser.name}.` }] }
            };
            if (imageData) {
                body.contents[0].parts.push({
                    inlineData: { mimeType: imageData.mime, data: imageData.base64 }
                });
            }
            const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${key}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(body)
            });
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text;
        }

        async function callOpenAI(text, imageData = null) {
            const key = localStorage.getItem('medassist_openai_key');
            if (!key) throw new Error('No OpenAI API key');
            
            const content = [{ type: 'text', text }];
            if (imageData) {
                content.push({
                    type: 'image_url',
                    image_url: { url: `data:${imageData.mime};base64,${imageData.base64}` }
                });
            }
            const res = await fetch('https://api.openai.com/v1/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [{ role: 'user', content }]
                })
            });
            const data = await res.json();
            return data.choices?.[0]?.message?.content;
        }

        async function callAnthropic(text, imageData = null) {
            const key = localStorage.getItem('medassist_anthropic_key');
            if (!key) throw new Error('No Anthropic API key');
            
            const content = [{ type: 'text', text }];
            if (imageData) {
                content.push({
                    type: 'image',
                    source: { type: 'base64', media_type: imageData.mime, data: imageData.base64 }
                });
            }
            const res = await fetch('https://api.anthropic.com/v1/messages', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'x-api-key': key, 'anthropic-version': '2023-06-01' },
                body: JSON.stringify({
                    model: 'claude-3-5-sonnet-20241022',
                    max_tokens: 1024,
                    messages: [{ role: 'user', content }]
                })
            });
            const data = await res.json();
            return data.content?.[0]?.text;
        }

        async function callAI(text, imageData = null) {
            const provider = getApiProvider();
            if (provider === 'gemini') return callGemini(text, imageData);
            if (provider === 'openai') return callOpenAI(text, imageData);
            if (provider === 'anthropic') return callAnthropic(text, imageData);
        }

        // --- OCR FUNCTIONS ---
        async function callOCRSpace(base64, mime) {
            const key = localStorage.getItem('medassist_ocrspace_key');
            const formData = new FormData();
            formData.append('base64Image', `data:${mime};base64,${base64}`);
            formData.append('apikey', key || 'K87899142');
            formData.append('language', 'eng');
            
            const res = await fetch('https://api.ocr.space/parse/image', {
                method: 'POST',
                body: formData
            });
            const data = await res.json();
            return data.ParsedText;
        }

        async function callOCR(base64, mime) {
            const provider = localStorage.getItem('medassist_ocr_provider') || 'ocrspace';
            if (provider === 'ocrspace') {
                return await callOCRSpace(base64, mime);
            } else {
                return await callAI('Extract all medication names, dosages, and times from this prescription image. Return as JSON: [{name, dose, time}]', { base64, mime });
            }
        }

        function appendMsg(text, sender) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `chat-msg msg-${sender}`;
            div.innerHTML = text === 'typing' ? '<div class="flex gap-2"><div class="typing-dot"></div><div class="typing-dot" style="animation-delay:0.2s"></div><div class="typing-dot" style="animation-delay:0.4s"></div></div>' : text;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            return div;
        }

        async function handleChatSubmit(e) {
            e.preventDefault();
            if (!canUseApi()) { appendMsg('API limit reached.', 'bot'); return; }
            if (!getApiKey()) { toggleAiSheet(false); toggleSettingsModal(true); return; }
            
            const text = document.getElementById('chat-input').value.trim();
            if (!text) return;
            
            appendMsg(text, 'user');
            document.getElementById('chat-input').value = '';
            const typing = appendMsg('typing', 'bot');
            
            try {
                const response = await callAI(text);
                incrementApiUsage();
                typing.remove();
                appendMsg(response || 'Error', 'bot');
            } catch (err) {
                typing.remove();
                appendMsg('API Error. Check settings.', 'bot');
            }
        }

        function triggerScan() {
            if (!getApiKey()) { toggleSettingsModal(true); return; }
            document.getElementById('scan-input').click();
            toggleFabMenu();
        }

        async function handleFileSelect(e) {
            const file = e.target.files[0];
            if (!file || !canUseApi()) { alert('API limit or no file'); return; }
            
            const loader = document.getElementById('scan-loader');
            loader.classList.remove('hidden');
            
            const reader = new FileReader();
            reader.onload = async (event) => {
                try {
                    const base64 = event.target.result.split(',')[1];
                    const mime = file.type || 'image/png';
                    
                    let ocrText = await callOCR(base64, mime);
                    incrementApiUsage();
                    
                    const parsePrompt = `From this text: "${ocrText}", extract medications as JSON array: [{name, dose, time}]. Return only JSON.`;
                    let medsJson = await callAI(parsePrompt);
                    incrementApiUsage();
                    
                    const meds = JSON.parse(medsJson.match(/\[.*\]/s)[0]);
                    meds.forEach(m => {
                        medications.push({
                            id: Math.random().toString(36).substr(2,9),
                            name: m.name || 'Unknown',
                            dose: m.dose || 'Dose',
                            time: m.time || '09:00',
                            frequency: 'daily',
                            startDate: new Date().toISOString().split('T')[0],
                            endDate: null
                        });
                    });
                    localStorage.setItem(`ms_meds_${currentUser.email}`, JSON.stringify(medications));
                    renderAll();
                    
                    document.getElementById('loader-spinner').classList.add('hidden');
                    document.getElementById('loader-success').classList.remove('hidden');
                    document.getElementById('loader-title').innerText = 'Success!';
                    document.getElementById('loader-text').innerText = `Added ${meds.length}`;
                    document.getElementById('loader-close').classList.remove('hidden');
                } catch (err) {
                    document.getElementById('loader-spinner').classList.add('hidden');
                    document.getElementById('loader-title').innerText = 'Error';
                    document.getElementById('loader-text').innerText = err.message;
                    document.getElementById('loader-close').classList.remove('hidden');
                }
            };
            reader.readAsDataURL(file);
        }

        function closeLoader() { document.getElementById('scan-loader').classList.add('hidden'); }
    </script>
</body>
</html>
